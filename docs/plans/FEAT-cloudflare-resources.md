# Workplan: Cloudflare Resources Setup

- **Task ID**: FEAT-cloudflare-resources
- **Problem Statement**: Set up the necessary Cloudflare D1 database and Key-Value (KV) namespaces. This involves adding their configurations to the existing `wrangler.jsonc`, creating the resources via Wrangler CLI, and then updating `wrangler.jsonc` with the generated IDs.
- **Components Involved**:
  - Cloudflare Wrangler CLI
  - `wrangler.jsonc` configuration file
  - Cloudflare account
- **Dependencies**:
  - Cloudflare account access and Wrangler CLI installed and configured.
  - Existing `wrangler.jsonc` file with base configuration.
- **Implementation Checklist**:
  - [x] **Prepare `wrangler.jsonc`**: Ensure `wrangler.jsonc` is ready to have `d1_databases` and `kv_namespaces` arrays added/updated. These arrays will initially contain placeholder IDs or be structured to receive them.
  - [x] **Create D1 Database**: Execute `wrangler d1 create snippet-index`.
  - [x] **Update `wrangler.jsonc` with D1 ID**: Add/modify the `d1_databases` array in `wrangler.jsonc` to include an object for `snippet-index` with its `binding` ("DB"), `database_name` ("snippet-index"), and the `database_id` obtained from the previous command.
  - [x] **Create KV Namespace (Cache)**: Execute `wrangler kv namespace create SNIPPET_CACHE`.
  - [x] **Update `wrangler.jsonc` with Cache KV IDs**: Add/modify the `kv_namespaces` array in `wrangler.jsonc` to include an object for `SNIPPET_CACHE` with its `binding`, and the `id` and `preview_id` obtained from the previous command.
  - [x] **Create KV Namespace (Passwords)**: Execute `wrangler kv namespace create APP_PASSWORDS`.
  - [x] **Update `wrangler.jsonc` with Passwords KV IDs**: Add/modify the `kv_namespaces` array in `wrangler.jsonc` to include an object for `APP_PASSWORDS` with its `binding`, and the `id` and `preview_id` obtained from the previous command.
  - [x] **Add other configurations to `wrangler.jsonc`**: Ensure `durable_objects`, `triggers`, and `vars` sections from `plan.md` (section 2) are also present in `wrangler.jsonc`.
- **Verification Steps**:
  - Ran `wrangler d1 execute snippet-index --command "SELECT 1;" --local` successfully (returned `1`). Addressed a Wrangler warning by adding a `migrations` block for the `FirehoseIngestor` Durable Object to `wrangler.jsonc`.
  - Ran `wrangler kv key list --namespace-id 83b2b6fab0f141fb960d813fdd6a9c48` (for `SNIPPET_CACHE`) successfully (returned empty list, as expected).
  - Ran `wrangler kv key list --namespace-id 44a9ce04d4df4e29af201c4b736f0bb0` (for `APP_PASSWORDS`) successfully (returned empty list, as expected).
  - The `APP_PWD_KEY` secret was set using `wrangler secret put APP_PWD_KEY`.
- **Decision Authority**:
  - **Cascade can**: Execute wrangler commands, update `wrangler.jsonc` based on command outputs.
  - **User must**: Ensure Wrangler is logged in and has necessary permissions.
- **Questions/Uncertainties**:
  - *Blocking*: None anticipated if Wrangler is set up.
  - *Non-blocking*: Specific IDs for D1/KV will be generated by Cloudflare and need to be captured.
- **Acceptable Tradeoffs**: Using `--local` for initial verification is acceptable for speed.
- **Status**: Completed
- **Notes**: All Cloudflare resources (D1, KV namespaces) were created and `wrangler.jsonc` updated accordingly. The `kv:namespace create` commands in the checklist were executed as `kv namespace create`. A warning regarding Durable Object migrations for `FirehoseIngestor` was addressed by adding the `migrations` configuration to `wrangler.jsonc`. The `APP_PWD_KEY` secret was set. User ensured they were logged into Cloudflare.
